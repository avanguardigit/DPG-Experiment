<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DPG Nutrition ‚Äî Energia vera, ogni giorno.</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dpg: { DEFAULT: '#2D6A4F', dark: '#1B4332', light: '#D8F3DC', mid: '#40916C', accent: '#52B788' },
            warm: '#FEFAE0',
            earth: '#6B4226',
            gold: '#E9C46A',
            alert: '#E63946',
            cat: { classic: '#5C3D2E', plant: '#40916C', flour: '#DDA15E', spread: '#BC6C25' },
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <style>
    /* Solo ci√≤ che Tailwind non copre: animazioni shell */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #shell-loader .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #D8F3DC;
      border-top-color: #2D6A4F;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    #shell-loader {
      transition: opacity .3s;
    }

    #content.fade-enter {
      opacity: 0;
      transform: translateY(8px);
    }

    #content.fade-active {
      transition: opacity .35s, transform .35s;
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body class="bg-warm text-dpg-dark font-sans min-h-screen flex flex-col">

  <!-- ============ HEADER ============ -->
  <header id="shell-header"
    class="bg-dpg-dark text-white px-6 h-16 flex items-center justify-between sticky top-0 z-50 shrink-0">
    <div id="shell-logo" onclick="navigate('home')"
      class="text-xl font-bold tracking-tight cursor-pointer hover:opacity-80 transition-opacity">
      <span class="text-dpg-accent">DPG</span> Nutrition
    </div>
    <nav id="shell-nav" class="hidden md:flex gap-8">
      <a onclick="navigate('catalogo completo prodotti DPG Nutrition')"
        class="text-white/80 hover:text-white text-sm font-medium cursor-pointer transition-colors">Prodotti</a>
      <a onclick="navigate('sezione ricette con prodotti DPG Nutrition')"
        class="text-white/80 hover:text-white text-sm font-medium cursor-pointer transition-colors">Ricette</a>
      <a onclick="navigate('chi siamo, storia e mission di DPG Nutrition')"
        class="text-white/80 hover:text-white text-sm font-medium cursor-pointer transition-colors">Chi Siamo</a>
    </nav>
    <div class="flex items-center gap-2">
      <input type="text" id="shell-search-input" placeholder="Cerca..." aria-label="Cerca nel sito"
        class="bg-white/10 border border-white/20 rounded-md px-3 py-1.5 text-sm text-white placeholder-white/40 w-48 md:w-52 outline-none focus:border-dpg-accent focus:bg-white/15 transition">
      <button id="shell-search-btn" aria-label="Cerca"
        class="bg-dpg text-white rounded-md px-3 py-1.5 text-sm cursor-pointer hover:bg-dpg-mid transition-colors">&#x2315;</button>
    </div>
  </header>

  <!-- ============ CONTENT ============ -->
  <main id="content" class="flex-1 w-full max-w-6xl mx-auto px-6 py-8"></main>

  <!-- ============ FOOTER ============ -->
  <footer id="shell-footer" class="bg-dpg-dark text-white/50 text-center px-6 py-5 text-xs leading-relaxed shrink-0">
    <strong class="text-white/75">DPG Nutrition S.r.l.</strong> ‚Äî Parma, Italia<br>
    Questo √® un sito dimostrativo ‚Äî DPG Nutrition √® un brand fittizio.<br>
    I valori nutrizionali possono variare. Consultare un professionista.
  </footer>

  <!-- ============ LOADER ============ -->
  <div id="shell-loader"
    class="fixed inset-0 bg-warm/90 flex flex-col items-center justify-center z-[100] opacity-0 pointer-events-none">
    <div class="spinner"></div>
    <p id="shell-loader-text" class="mt-4 text-dpg font-medium text-sm">Generazione in corso...</p>
    <p id="shell-loader-timer" class="mt-2 text-dpg-mid/60 text-xs font-mono tabular-nums">0.0s</p>
  </div>

  <!-- ============ HOME PAGE STATICA ============ -->
  <template id="home-template">
    <section class="text-center pt-20 pb-12 px-4">
      <h1 class="text-5xl md:text-6xl font-bold tracking-tight text-dpg-dark mb-3">DPG Nutrition</h1>
      <p class="text-lg text-dpg-accent font-medium mb-10">Energia vera, ogni giorno.</p>
      <a data-navigate="catalogo completo prodotti DPG Nutrition"
        class="inline-block bg-dpg text-white px-8 py-3 rounded-lg font-semibold hover:bg-dpg-mid hover:-translate-y-0.5 transition-all cursor-pointer">
        Scopri i prodotti
      </a>
    </section>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 max-w-3xl mx-auto mb-16">
      <a data-navigate="barrette proteiche DPG Nutrition ‚Äî linea Classic e Plant"
        class="bg-white rounded-xl p-8 text-center cursor-pointer no-underline text-inherit border border-dpg/5 hover:-translate-y-1 hover:shadow-lg hover:shadow-dpg-dark/10 transition-all">
        <span class="text-4xl block mb-3">üç´</span>
        <h3 class="text-base font-bold mb-1">Barrette Proteiche</h3>
        <p class="text-sm text-gray-500 leading-relaxed">Classic e Plant ‚Äî fino a 20g di proteine per barretta.</p>
      </a>
      <a data-navigate="farine proteiche DPG Nutrition per ricette sane"
        class="bg-white rounded-xl p-8 text-center cursor-pointer no-underline text-inherit border border-dpg/5 hover:-translate-y-1 hover:shadow-lg hover:shadow-dpg-dark/10 transition-all">
        <span class="text-4xl block mb-3">üåæ</span>
        <h3 class="text-base font-bold mb-1">Farine Proteiche</h3>
        <p class="text-sm text-gray-500 leading-relaxed">Avena, riso integrale, multicereali. La base per ogni ricetta.
        </p>
      </a>
      <a data-navigate="creme proteiche spalmabili DPG Nutrition"
        class="bg-white rounded-xl p-8 text-center cursor-pointer no-underline text-inherit border border-dpg/5 hover:-translate-y-1 hover:shadow-lg hover:shadow-dpg-dark/10 transition-all">
        <span class="text-4xl block mb-3">ü•ú</span>
        <h3 class="text-base font-bold mb-1">Creme Spalmabili</h3>
        <p class="text-sm text-gray-500 leading-relaxed">Arachidi e mandorle. Naturali, senza zuccheri aggiunti.</p>
      </a>
    </div>

    <section class="text-center pb-16 px-4">
      <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-widest mb-5">Esplora</h2>
      <div class="flex justify-center gap-3 flex-wrap">
        <a data-navigate="ricette facili e veloci con prodotti DPG Nutrition"
          class="bg-dpg-light text-dpg-dark px-5 py-2 rounded-full text-sm font-medium cursor-pointer hover:bg-dpg-accent/30 hover:-translate-y-0.5 transition-all">Ricette</a>
        <a data-navigate="prodotti bestseller DPG Nutrition"
          class="bg-dpg-light text-dpg-dark px-5 py-2 rounded-full text-sm font-medium cursor-pointer hover:bg-dpg-accent/30 hover:-translate-y-0.5 transition-all">Bestseller</a>
        <a data-navigate="chi siamo, storia e mission di DPG Nutrition"
          class="bg-dpg-light text-dpg-dark px-5 py-2 rounded-full text-sm font-medium cursor-pointer hover:bg-dpg-accent/30 hover:-translate-y-0.5 transition-all">La
          nostra storia</a>
        <a data-navigate="domande frequenti su DPG Nutrition"
          class="bg-dpg-light text-dpg-dark px-5 py-2 rounded-full text-sm font-medium cursor-pointer hover:bg-dpg-accent/30 hover:-translate-y-0.5 transition-all">FAQ</a>
      </div>
    </section>
  </template>

  <!-- ============ JAVASCRIPT ============ -->
  <script>
    const contentEl = document.getElementById('content');
    const loaderEl = document.getElementById('shell-loader');
    const loaderText = document.getElementById('shell-loader-text');
    const loaderTimer = document.getElementById('shell-loader-timer');
    const searchInput = document.getElementById('shell-search-input');
    const searchBtn = document.getElementById('shell-search-btn');
    const homeHTML = document.getElementById('home-template').innerHTML;

    const pageCache = new Map();
    pageCache.set('home', homeHTML);

    let currentIntent = null;
    let generating = false;

    // ------ Profilo utente (cookie-based, aggiornamento asincrono) ------

    const PROFILE_COOKIE = 'dpg_profile';

    function getProfile() {
      try {
        const match = document.cookie.match(new RegExp('(?:^|; )' + PROFILE_COOKIE + '=([^;]*)'));
        if (match) return JSON.parse(decodeURIComponent(match[1]));
      } catch { }
      return null;
    }

    function saveProfile(profile) {
      if (!profile) return;
      const encoded = encodeURIComponent(JSON.stringify(profile));
      // Cookie dura 30 giorni, path root, SameSite Strict
      document.cookie = `${PROFILE_COOKIE}=${encoded}; path=/; max-age=${60 * 60 * 24 * 30}; SameSite=Strict`;
    }

    let lastIntent = null;

    function updateProfileAsync(intent) {
      // Chiamata in background ‚Äî non blocca nulla
      const currentProfile = getProfile();
      fetch('/api/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ intent, previous_intent: lastIntent, profile: currentProfile }),
      })
        .then(res => res.json())
        .then(data => {
          if (data.profile) {
            saveProfile(data.profile);
            // Invalida la cache SOLO se il profilo √® cambiato in modo significativo
            // (nuovi interessi, cambio behavior/ux_hints, non solo visited_count++)
            if (data.profile_changed) {
              pageCache.clear();
              pageCache.set('home', homeHTML);
            }
          }
        })
        .catch(() => { }); // Fallisce silenziosamente ‚Äî non √® critico
      lastIntent = intent;
    }

    // ------ Navigation ------

    // Pattern pericolosi ‚Äî bloccati prima di chiamare l'LLM
    const BLOCKED_INTENTS = [
      'admin', 'login', 'signin', 'signup', 'register', 'auth',
      'dashboard', 'panel', 'console', 'terminal',
      'edit', 'delete', 'remove', 'insert', 'update', 'modify',
      'nuovo', 'nuova', 'crea', 'aggiungi', 'gestione', 'gestisci', 'manage',
      'form', 'submit', 'save', 'salva',
      'config', 'settings', 'debug', 'upload', 'download',
      'database', 'sql', 'password', 'token', 'secret', 'credential',
      'wp-admin', 'phpmyadmin', 'cpanel',
      'partnership', 'fornitor', 'inventario', 'stock', 'fattur',
      'contratt', 'margin', 'costi-produzione', 'interno',
    ];

    function isBlockedIntent(intent) {
      const lower = intent.toLowerCase();
      return BLOCKED_INTENTS.some(p => lower.includes(p));
    }

    async function navigate(intent, pushHistory = true) {
      if (!intent || generating) return;
      intent = intent.trim();

      // Anti-intrusion: traccia tentativi sospetti nel profilo
      if (isBlockedIntent(intent)) {
        const p = getProfile() || {};
        p.suspicious_attempts = (p.suspicious_attempts || 0) + 1;
        saveProfile(p);
        // Dopo 5+ tentativi sospetti ‚Üí l'utente √® un potenziale attaccante,
        // mostra solo home statica senza chiamare l'LLM
        if (p.suspicious_attempts >= 5) {
          injectContent(homeHTML);
          if (pushHistory) history.pushState({ intent: 'home' }, '', '/');
          return;
        }
        navigate('home', pushHistory);
        return;
      }

      currentIntent = intent;

      if (pageCache.has(intent)) {
        injectContent(pageCache.get(intent));
        if (pushHistory) pushState(intent);
        // Aggiorna profilo anche su cache hit
        if (intent !== 'home') updateProfileAsync(intent);
        return;
      }

      showLoader(true, 'Generazione in corso...');
      generating = true;

      try {
        const body = { intent };
        const profile = getProfile();
        if (profile) body.profile = profile;

        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const data = await res.json();

        if (!res.ok || data.error) {
          throw new Error(data.error || 'Errore sconosciuto');
        }

        // Permettiamo l'utilizzo di JS da parte del LLM. NOTA BENE:
        // Configurare DOMPurify per non rimuovere JS aumenta il rischio
        // sebbene possiamo limitarlo al solo inline ed evitare richieste esterne incrociate,
        // al momento passiamo FORCE_BODY in modo che DOMPurify mantenga i tag script.
        const cleanHtml = DOMPurify.sanitize(data.html, { ALLOWED_TAGS: ['script', 'style', '#text', 'div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'a', 'b', 'i', 'strong', 'em', 'img', 'br', 'hr', 'table', 'tbody', 'thead', 'tr', 'td', 'th', 'button', 'svg', 'path', 'code', 'pre', 'blockquote', 'section', 'article', 'header', 'footer', 'nav', 'main', 'iframe', 'video', 'audio', 'source', 'form', 'input', 'textarea', 'select', 'option', 'label', 'fieldset', 'legend', 'details', 'summary', 'figure', 'figcaption', 'time', 'mark', 'ruby', 'rb', 'rt', 'rtc', 'rp', 'bdi', 'bdo', 'wbr', 'del', 'ins', 'kbd', 'samp', 'var', 'sub', 'sup', 'small', 's', 'cite', 'q', 'dfn', 'abbr', 'address'] });

        pageCache.set(intent, cleanHtml);
        injectContent(cleanHtml);
        if (pushHistory) pushState(intent);

        // Aggiornamento profilo ASINCRONO ‚Äî parte dopo il render, non blocca l'utente
        if (intent !== 'home') updateProfileAsync(intent);
      } catch (err) {
        injectContent(errorPage(err.message, intent));
      } finally {
        generating = false;
        showLoader(false);
      }
    }

    // ------ DOM helpers ------

    function injectContent(html) {
      contentEl.classList.remove('fade-active');
      contentEl.classList.add('fade-enter');
      contentEl.innerHTML = html;

      // WORKAROUND: innerHTML non esegue i tag <script>. 
      // Dobbiamo estrarli, crearne di nuovi e appenderli al DOM.
      const scripts = contentEl.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });

      window.scrollTo({ top: 0, behavior: 'instant' });

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          contentEl.classList.remove('fade-enter');
          contentEl.classList.add('fade-active');
        });
      });
    }

    function pushState(intent) {
      if (intent === 'home') {
        history.pushState({ intent }, '', '/');
      } else {
        const slug = intentToSlug(intent);
        history.pushState({ intent }, '', '/' + slug);
      }
      // Aggiorna anche il title della pagina
      document.title = intent === 'home'
        ? 'DPG Nutrition'
        : intent.charAt(0).toUpperCase() + intent.slice(1) + ' | DPG Nutrition';
    }

    function intentToSlug(intent) {
      return intent
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
    }

    function slugToIntent(slug) {
      return decodeURIComponent(slug).replace(/-/g, ' ').trim();
    }

    function errorPage(msg, failedIntent) {
      return `<div class="text-center py-16 px-8">
        <h2 class="text-alert text-xl font-bold mb-3">Qualcosa √® andato storto</h2>
        <p class="text-gray-500 mb-6">${msg}</p>
        <button onclick="navigate('${failedIntent.replace(/'/g, "\\'")}')"
          class="bg-dpg text-white px-6 py-2.5 rounded-lg font-semibold cursor-pointer hover:bg-dpg-mid transition-colors">Riprova</button>
      </div>`;
    }

    // ------ Loader with timer ------

    let loaderInterval = null;
    let loaderStart = 0;

    function showLoader(show, text) {
      if (show) {
        if (text) loaderText.textContent = text;
        loaderEl.style.opacity = '1';
        loaderEl.style.pointerEvents = 'all';
        if (!loaderInterval) {
          loaderStart = Date.now();
          loaderTimer.textContent = '0.0s';
          loaderInterval = setInterval(() => {
            const elapsed = ((Date.now() - loaderStart) / 1000).toFixed(1);
            loaderTimer.textContent = elapsed + 's';
          }, 100);
        }
      } else {
        loaderEl.style.opacity = '0';
        loaderEl.style.pointerEvents = 'none';
        if (loaderInterval) {
          clearInterval(loaderInterval);
          loaderInterval = null;
        }
      }
    }

    // ------ Event delegation for data-navigate ------

    document.addEventListener('click', (e) => {
      const link = e.target.closest('[data-navigate]');
      if (link) {
        e.preventDefault();
        navigate(link.dataset.navigate);
      }
    });

    // ------ Search ------

    function doSearch() {
      const q = searchInput.value.trim();
      if (q) {
        navigate('ricerca: ' + q);
        searchInput.value = '';
        searchInput.blur();
      }
    }

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSearch();
    });
    searchBtn.addEventListener('click', doSearch);

    // ------ History API ------

    window.addEventListener('popstate', (e) => {
      if (e.state?.intent) {
        navigate(e.state.intent, false);
      } else {
        navigate('home', false);
      }
    });

    // ------ Boot (legge URL path al caricamento) ------

    (function boot() {
      const pathname = location.pathname;

      // Supporta anche vecchi link con hash (backward compat)
      const hash = decodeURIComponent(location.hash.slice(1));
      if (hash) {
        navigate(hash, false);
        // Riscrivi l'URL con lo slug pulito
        history.replaceState({ intent: hash }, '', '/' + intentToSlug(hash));
        return;
      }

      if (pathname === '/' || pathname === '') {
        injectContent(homeHTML);
        history.replaceState({ intent: 'home' }, '', '/');
      } else {
        // Converti l'URL in intent e naviga
        const cleanPath = pathname
          .replace(/^\/prodotti\//, '')
          .replace(/^\/ricette\//, 'ricetta ')
          .replace(/^\//, '');
        const intent = slugToIntent(cleanPath);
        if (intent) {
          navigate(intent, false);
        } else {
          injectContent(homeHTML);
          history.replaceState({ intent: 'home' }, '', '/');
        }
      }
    })();
  </script>
</body>

</html>